<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æ³¥æ¡¶è£½é€ å±¤æ•¸è¨ˆç®—å™¨ (SVGç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; font-weight: 700; }
        
        /* Grid Layout */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        /* Input Section */
        .input-section { background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; }
        .section-title { font-size: 1.1em; font-weight: 700; color: #495057; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #dee2e6; }
        .input-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9em; }
        input { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: all 0.3s; font-family: 'Roboto Mono', monospace; }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        
        /* Button */
        .calc-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4); }

        /* Result Section */
        .result-box { display: none; /* åˆå§‹éš±è— */ }
        .card { background: #fff; border: 1px solid #eee; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card-header { padding: 15px 20px; font-weight: 700; color: #fff; }
        .card-body { padding: 20px; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #f1f1f1; padding-bottom: 8px; font-size: 0.95em;}
        .result-row:last-child { border-bottom: none; }
        .result-row strong { font-family: 'Roboto Mono', monospace; color: #2d3436; }
        .highlight-val { color: #e74c3c !important; font-size: 1.2em; }

        /* SVG Diagram Container */
        .diagram-container {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            overflow: hidden;
        }
        #siloSvg {
            max-height: 500px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            width: auto;
            max-width: 100%;
        }
        /* SVG å…§éƒ¨æ¨£å¼ */
        .svg-dim-line { stroke: #7f8c8d; stroke-width: 1; }
        .svg-dim-text { font-family: 'Roboto Mono', monospace; font-size: 12px; fill: #7f8c8d; }
        .svg-silo-body { fill: #bdc3c7; stroke: #7f8c8d; stroke-width: 2; }
        .svg-silo-cone { fill: #95a5a6; stroke: #7f8c8d; stroke-width: 2; }
        .svg-layer-line { stroke: #7f8c8d; stroke-width: 1; stroke-dasharray: 4 2; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ—ï¸ æ°´æ³¥æ¡¶è£½é€ å±¤æ•¸è¨ˆç®—å™¨ (PROç‰ˆ)</h2>
    
    <div class="main-grid">
        <div>
            <div class="input-section">
                <div class="section-title">ğŸ“‹ åŸºæœ¬éœ€æ±‚</div>
                <div class="input-group">
                    <label>éœ€æ±‚æ°´æ³¥é‡é‡ (Tons)</label>
                    <input type="number" id="weight" value="150">
                </div>
                <div class="input-group">
                    <label>æ°´æ³¥æ¯”é‡ (t/mÂ³)</label>
                    <input type="number" id="density" value="1.33" step="0.01">
                </div>
                <div class="input-group">
                    <label>å®‰å…¨é ç•™é«˜åº¦ (m) <small style="color:#888;">(ä¾‹å¦‚:é™¤å¡µå™¨ç©ºé–“)</small></label>
                    <input type="number" id="freeboard" value="0.5" step="0.1">
                </div>
            </div>
            <div class="input-section" style="margin-top: 20px;">
                <div class="section-title">âš™ï¸ å°ºå¯¸èˆ‡è£½ç¨‹è¦æ ¼</div>
                <div class="input-group">
                    <label>æ¡¶èº«ç›´å¾‘ (m)</label>
                    <input type="number" id="diameter" value="4.37" step="0.01">
                </div>
                <div class="input-group">
                    <label>å–®å±¤é‹¼æ¿é«˜åº¦ (m)</label>
                    <input type="number" id="plate_h" value="1.5" step="0.1">
                </div>
                <div class="input-group">
                    <label>éŒæ–—æ–œåº¦ (åº¦)</label>
                    <input type="number" id="angle" value="60">
                </div>
                <div class="input-group">
                    <label>ä¸‹æ–¹å‡ºå£ç›´å¾‘ (m)</label>
                    <input type="number" id="outlet" value="0.32" step="0.01">
                </div>
            </div>
            <button class="calc-btn" onclick="calculateSilo()" style="margin-top: 25px;">é–‹å§‹è¨ˆç®—èˆ‡ç¹ªåœ–</button>
        </div>

        <div id="result" class="result-box">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #00b894, #00cec9);">ğŸ› ï¸ è£½é€ è¦æ ¼å»ºè­°</div>
                <div class="card-body">
                    <div class="result-row">
                        <span>ç›´èº«æ®µéœ€è¦çš„å±¤æ•¸ï¼š</span>
                        <strong class="highlight-val"><span id="res-layers"></span> å±¤</strong>
                    </div>
                    <div class="result-row">
                        <span>å–®å±¤æ¿é«˜ï¼š</span>
                        <strong><span id="res-plate-h"></span> m</strong>
                    </div>
                    <div class="result-row">
                        <span>ç›´èº«æ®µå¯¦éš›é«˜åº¦ï¼š</span>
                        <strong><span id="res-cyl-h-actual"></span> m</strong>
                    </div>
                    <div class="result-row">
                        <span>éŒæ–—æ®µé«˜åº¦ï¼š</span>
                        <strong><span id="res-cone-h"></span> m</strong>
                    </div>
                    <div class="result-row" style="background:#f8f9fa; padding:8px; border-radius:6px; margin-top:5px;">
                        <span style="font-weight:700;">ğŸ“ æ¡¶é«”ç¸½é«˜åº¦ (ä¸å«è…³æ¶)ï¼š</span>
                        <strong class="highlight-val" style="color:#2c3e50 !important;"><span id="res-total-h"></span> m</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #0984e3, #74b9ff);">ğŸ“Š å®¹é‡é©—è­‰</div>
                <div class="card-body">
                    <div class="result-row">
                        <span>éœ€æ±‚ç¸½å®¹ç©ï¼š</span>
                        <span><span id="res-vol-req"></span> mÂ³</span>
                    </div>
                    <div class="result-row">
                        <span>è¨­è¨ˆå¯¦éš›ç¸½å®¹ç©ï¼š</span>
                        <strong><span id="res-vol-actual"></span> mÂ³</strong>
                    </div>
                    <div class="result-row">
                        <span>é ä¼°æœ€å¤§è£è¼‰é‡é‡ï¼š</span>
                        <strong style="color:#0984e3"><span id="res-weight-max"></span> T</strong>
                    </div>
                    <div class="result-row">
                        <span>ç‹€æ…‹è©•ä¼°ï¼š</span>
                        <strong id="res-status"></strong>
                    </div>
                </div>
            </div>

            <div class="diagram-container">
                <h4 style="margin-top:0; color:#7f8c8d;">è¨­è¨ˆçµæ§‹ç¤ºæ„åœ– (è‡ªå‹•æ¯”ä¾‹)</h4>
                <svg id="siloSvg" viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                          <path d="M0,0 L0,6 L9,3 z" fill="#7f8c8d" />
                        </marker>
                    </defs>
                    </svg>
            </div>
        </div>
    </div>
</div>

<script>
    function calculateSilo() {
        // --- 1. ç²å–è¼¸å…¥èˆ‡é©—è­‰ ---
        let getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        let W = getVal('weight');
        let rho = getVal('density');
        let D = getVal('diameter');
        let plateH = getVal('plate_h');
        let angleDeg = getVal('angle');
        let d_out = getVal('outlet');
        let freeboard = getVal('freeboard');

        if(W<=0 || rho<=0 || D<=0 || plateH<=0 || angleDeg<=0 || d_out<=0) {
            alert("è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æœ‰æ•ˆæ•¸å€¼ï¼");
            return;
        }

        // --- 2. å¹¾ä½•é‹ç®—æ ¸å¿ƒ ---
        let R = D / 2;
        let r = d_out / 2;
        let angleRad = angleDeg * (Math.PI / 180);
        let V_needed = W / rho;

        // éŒæ–—è¨ˆç®—
        let h_cone = (R - r) * Math.tan(angleRad);
        let V_cone = (Math.PI * h_cone / 3) * (Math.pow(R, 2) + R * r + Math.pow(r, 2));

        // ç›´èº«è¨ˆç®—
        let V_cyl_needed = V_needed - V_cone;
        let area_cyl = Math.PI * Math.pow(R, 2);
        let h_cyl_theoretical = V_cyl_needed > 0 ? V_cyl_needed / area_cyl : 0;

        // --- 3. DFMå±¤æ•¸å„ªåŒ– ---
        let h_cyl_target = h_cyl_theoretical + freeboard;
        let layers = Math.ceil(h_cyl_target / plateH);
        if (layers === 0 && h_cyl_target > 0) layers = 1; // è‡³å°‘ä¸€å±¤
        let h_cyl_actual = layers * plateH;
        
        // åæ¨å®¹é‡
        let V_cyl_actual = area_cyl * h_cyl_actual;
        let V_total_actual = V_cyl_actual + V_cone;
        let W_max_actual = V_total_actual * rho;
        let h_total = h_cyl_actual + h_cone;

        // --- 4. æ›´æ–°æ•¸æ“šä»‹é¢ ---
        document.getElementById('result').style.display = 'block';
        
        // Helper å‡½æ•¸ç°¡åŒ– DOM æ“ä½œ
        let setTxt = (id, val, fixed=2) => document.getElementById(id).innerText = val.toFixed(fixed);
        
        setTxt('res-layers', layers, 0);
        setTxt('res-plate-h', plateH);
        setTxt('res-cyl-h-actual', h_cyl_actual);
        setTxt('res-cone-h', h_cone);
        setTxt('res-total-h', h_total);
        setTxt('res-vol-req', V_needed);
        setTxt('res-vol-actual', V_total_actual);
        setTxt('res-weight-max', W_max_actual, 1);

        let statusElem = document.getElementById('res-status');
        if(V_total_actual >= V_needed - 0.1) { // å…è¨±å¾®å°èª¤å·®
            statusElem.innerHTML = "âœ… åˆæ ¼ (å®¹é‡å……è¶³)";
            statusElem.style.color = "#27ae60";
        } else {
            statusElem.innerHTML = "âš ï¸ è­¦å‘Šï¼šå®¹é‡ä¸è¶³";
            statusElem.style.color = "#c0392b";
        }

        // --- 5. ç¹ªè£½ SVG å·¥ç¨‹åœ– ---
        drawSvgDiagram(D, d_out, h_cyl_actual, h_cone, layers, h_total);
    }

    function drawSvgDiagram(D, d_out, h_cyl, h_cone, layers, h_total) {
        const svg = document.getElementById('siloSvg');
        // æ¸…ç©ºèˆŠå…§å®¹ï¼Œåªä¿ç•™ defs
        svg.innerHTML = svg.querySelector('defs').outerHTML;

        // SVG ç•«å¸ƒè¨­å®š
        const svgWidth = 400;
        const svgHeight = 500;
        const marginX = 80; // å·¦å³ç•™ç™½çµ¦æ¨™è¨»
        const marginY = 40; // ä¸Šä¸‹ç•™ç™½
        const centerX = svgWidth / 2;
        const availableHeight = svgHeight - (marginY * 2);

        // è¨ˆç®—æ¯”ä¾‹å°º (Pixels per Meter)
        // ç¢ºä¿ç¸½é«˜åº¦èƒ½å¡é€²ç•«å¸ƒçš„é«˜
        let ppm = availableHeight / h_total;
        
        // é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…ç›´å¾‘å¤ªå¤§çˆ†å‡ºç•«å¸ƒ
        let maxAllowedWidthStr = (svgWidth - marginX*2) * 0.8;
        if (D * ppm > maxAllowedWidthStr) {
             ppm = maxAllowedWidthStr / D;
        }

        // è½‰æ›å°ºå¯¸ç‚ºåƒç´ 
        let cylW_px = D * ppm;
        let cylH_px = h_cyl * ppm;
        let coneH_px = h_cone * ppm;
        let outletW_px = d_out * ppm;
        let layerH_px = cylH_px / layers;

        let startY = marginY;
        let currentY = startY;

        // 1. ç¹ªè£½ç›´èº«æ®µ (åœ“æŸ±)
        let cylX = centerX - (cylW_px / 2);
        
        // ç¹ªè£½ä¸»é«”çŸ©å½¢
        let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", cylX);
        rect.setAttribute("y", currentY);
        rect.setAttribute("width", cylW_px);
        rect.setAttribute("height", cylH_px);
        rect.setAttribute("class", "svg-silo-body");
        svg.appendChild(rect);

        // ç¹ªè£½å±¤æ•¸åˆ†éš”ç·š
        for(let i=1; i<layers; i++) {
            let lineY = currentY + (i * layerH_px);
            let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", cylX);
            line.setAttribute("y1", lineY);
            line.setAttribute("x2", cylX + cylW_px);
            line.setAttribute("y2", lineY);
            line.setAttribute("class", "svg-layer-line");
            svg.appendChild(line);
        }
        currentY += cylH_px;

        // 2. ç¹ªè£½éŒæ–—æ®µ (æ¢¯å½¢/ä¸‰è§’å½¢)
        let coneTopLeftX = cylX;
        let coneTopRightX = cylX + cylW_px;
        let coneBottomLeftX = centerX - (outletW_px / 2);
        let coneBottomRightX = centerX + (outletW_px / 2);
        let coneBottomY = currentY + coneH_px;

        let polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        let points = `${coneTopLeftX},${currentY} ${coneTopRightX},${currentY} ${coneBottomRightX},${coneBottomY} ${coneBottomLeftX},${coneBottomY}`;
        polygon.setAttribute("points", points);
        polygon.setAttribute("class", "svg-silo-cone");
        svg.appendChild(polygon);

        // --- 3. ç¹ªè£½å°ºå¯¸æ¨™è¨» ---
        
        // Helper: ç•«æ¨™è¨»ç·šèˆ‡æ–‡å­—
        function drawDim(x1, y1, x2, y2, textStr, textX, textY, anchor="middle") {
            // ç·š
            let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1); line.setAttribute("y1", y1);
            line.setAttribute("x2", x2); line.setAttribute("y2", y2);
            line.setAttribute("class", "svg-dim-line");
            line.setAttribute("marker-start", "url(#arrow)");
            line.setAttribute("marker-end", "url(#arrow)");
            svg.appendChild(line);
            // æ–‡å­—
            let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", textX);
            text.setAttribute("y", textY);
            text.setAttribute("text-anchor", anchor);
            text.setAttribute("class", "svg-dim-text");
            text.textContent = textStr;
            svg.appendChild(text);
        }

        // æ¨™è¨»: ç›´å¾‘ (ä¸Šæ–¹)
        drawDim(cylX, startY - 15, cylX + cylW_px, startY - 15, `ç›´å¾‘: ${D.toFixed(2)}m`, centerX, startY - 25);

        // æ¨™è¨»: ç¸½é«˜åº¦ (å³å´)
        let dimX_right = cylX + cylW_px + 40;
        drawDim(dimX_right, startY, dimX_right, coneBottomY, `ç¸½é«˜: ${h_total.toFixed(2)}m`, dimX_right + 5, startY + (coneBottomY-startY)/2, "start");
        // è¼”åŠ©å»¶ä¼¸ç·š
        svg.appendChild(createExtLine(cylX + cylW_px, startY, dimX_right, startY));
        svg.appendChild(createExtLine(coneBottomRightX, coneBottomY, dimX_right, coneBottomY));

        // æ¨™è¨»: éŒæ–—é«˜åº¦ (å·¦å´)
        let dimX_left = cylX - 40;
        drawDim(dimX_left, startY + cylH_px, dimX_left, coneBottomY, `éŒæ–—: ${h_cone.toFixed(2)}m`, dimX_left - 5, startY + cylH_px + coneH_px/2, "end");
         // è¼”åŠ©å»¶ä¼¸ç·š
         svg.appendChild(createExtLine(dimX_left, startY + cylH_px, cylX, startY + cylH_px));
         svg.appendChild(createExtLine(dimX_left, coneBottomY, coneBottomLeftX, coneBottomY));

        // æ¨™è¨»: å‡ºå£ (ä¸‹æ–¹)
        drawDim(coneBottomLeftX, coneBottomY + 15, coneBottomRightX, coneBottomY + 15, `å‡ºå£: ${d_out}m`, centerX, coneBottomY + 30);

    }
    
    // Helper: å»ºç«‹å»¶ä¼¸è¼”åŠ©ç·š (ä¸å¸¶ç®­é ­çš„ç´°ç·š)
    function createExtLine(x1, y1, x2, y2) {
        let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1); line.setAttribute("y1", y1);
        line.setAttribute("x2", x2); line.setAttribute("y2", y2);
        line.setAttribute("stroke", "#bdc3c7");
        line.setAttribute("stroke-width", "0.5");
        return line;
    }

</script>

</body>
</html>
